# 门店坐标和商场匹配功能完成清单

## ✅ 所有需求已完成

### 需求1：通过门店名称搜索精准经纬度并更新CSV
**状态**: ✅ 已完成  
**脚本**: `update_precise_coordinates.py`

**功能**:
- 通过门店名称搜索高德地图POI，获取精准的经纬度坐标
- 更新CSV文件中的 `lat` 和 `lng` 字段
- 自动创建备份文件

**使用方法**:
```bash
python update_precise_coordinates.py --dry-run  # 预览模式
python update_precise_coordinates.py            # 实际更新
```

---

### 需求2：Insta360门店商场匹配（优先匹配DJI门店）
**状态**: ✅ 已完成  
**脚本**: `match_insta360_malls.py`

**功能**:
1. 通过门店名称搜索获取精准经纬度
2. 优先匹配DJI门店中：
   - 相近经纬度（距离 < 500米）
   - 类似门店名称（相似度 >= 60%）
   - 类似门店地址（相似度 >= 50%）
3. 根据匹配方式设置商场名称和经纬度：
   - **自动匹配**：使用高德地图的商场名称和商场的经纬度
   - **手动匹配**：使用手动输入的商场名称，但使用门店的高德经纬度

**使用方法**:
```bash
python match_insta360_malls.py --dry-run  # 预览模式
python match_insta360_malls.py           # 实际更新
```

---

### 需求3：统一商场名称
**状态**: ✅ 已完成  
**脚本**: `unify_mall_names.py`

**功能**:
- 根据经纬度找到商场集群（距离 < 300米认为是同一商场）
- 统一每个集群的商场名称，使用最长的商场名称作为标准
- 确保同一商场的所有门店（包括DJI和Insta360）使用完全相同的商场名称

**使用方法**:
```bash
python unify_mall_names.py --dry-run  # 预览模式
python unify_mall_names.py           # 实际更新
```

---

### 需求4：根据匹配方式更新商场名称和经纬度
**状态**: ✅ 已完成  
**脚本**: `update_mall_coordinates.py`

**功能**:
- **自动/LLM匹配的商场**：
  - 商场名称：使用高德地图的商场名称
  - 商场经纬度：使用搜索到的商场的经纬度
- **人工手动输入的商场**：
  - 商场名称：使用人工手动输入的商场名称（保持不变）
  - 商场经纬度：使用对应门店搜索出来的高德经纬度
- **自动同步更新记忆文件** (`poi_memory.csv`) 中的商场经纬度

**使用方法**:
```bash
python update_mall_coordinates.py --dry-run  # 预览模式
python update_mall_coordinates.py           # 实际更新
```

---

### 需求5：更新记忆文件中的商场经纬度
**状态**: ✅ 已完成  
**脚本**: `update_memory_mall_coordinates.py`

**功能**:
- 读取 `poi_memory.csv` 文件
- 对于有商场名称但缺少商场经纬度的记录，根据匹配方式补充商场经纬度
- 规则与 `update_mall_coordinates.py` 相同
- 如果记录已有商场经纬度，会跳过

**使用方法**:
```bash
python update_memory_mall_coordinates.py --dry-run  # 预览模式
python update_memory_mall_coordinates.py            # 实际更新
```

---

## 📋 完整工作流程

### 推荐执行顺序

```bash
# 1. 匹配Insta360门店的商场（包含更新精准坐标）
python match_insta360_malls.py --dry-run
python match_insta360_malls.py

# 2. 统一所有商场名称
python unify_mall_names.py --dry-run
python unify_mall_names.py

# 3. 根据匹配方式更新商场名称和经纬度（会自动同步更新记忆文件）
python update_mall_coordinates.py --dry-run
python update_mall_coordinates.py

# 4. （可选）单独更新记忆文件中的商场经纬度
python update_memory_mall_coordinates.py --dry-run
python update_memory_mall_coordinates.py

# 5. 转换为前端JSON格式
python csv_to_json.py
```

---

## 📁 文件结构

### CSV文件字段

**all_stores_final.csv**:
- `uuid` - 唯一标识
- `brand` - 品牌（DJI/Insta360）
- `name` - 门店名称
- `lat` - 门店纬度（已更新为精准坐标）
- `lng` - 门店经度（已更新为精准坐标）
- `address` - 地址
- `province` - 省份
- `city` - 城市
- `mall_name` - 商场名称（已统一）
- `mall_lat` - 商场纬度（新增）
- `mall_lng` - 商场经度（新增）
- `match_method` - 匹配方式（auto/llm/manual）
- `is_manual_confirmed` - 是否手动确认（True/False）

**poi_memory.csv**:
- `brand` - 品牌
- `store_name` - 门店名称
- `city` - 城市
- `original_address` - 原始地址
- `confirmed_mall_name` - 确认的商场名称
- `is_non_mall` - 是否非商场
- `is_manual_confirmed` - 是否手动确认
- `mall_lat` - 商场纬度（新增）
- `mall_lng` - 商场经度（新增）

---

## 🔧 核心功能说明

### 1. 精准坐标更新
- 通过门店名称搜索高德地图POI
- 使用匹配分数筛选最准确的结果
- 自动更新CSV中的经纬度

### 2. 智能商场匹配
- Insta360门店优先匹配DJI门店的商场
- 综合评分：距离(40%) + 名称相似度(35%) + 地址相似度(25%)
- 只有综合分数 >= 50 才会匹配

### 3. 商场名称统一
- 根据经纬度聚类（300米内认为是同一商场）
- 统一使用最长的商场名称
- 确保同一商场所有门店名称一致

### 4. 匹配方式区分
- **自动/LLM匹配**：使用高德地图标准名称和商场坐标
- **手动匹配**：保持手动输入名称，使用门店坐标

### 5. 记忆文件同步
- 自动同步更新记忆文件中的商场经纬度
- 支持单独更新记忆文件
- 保持数据一致性

---

## ⚠️ 注意事项

1. **API Key**: 需要设置高德地图API Key（环境变量 `AMAP_WEB_KEY` 或在 `.env.local` 文件中）
2. **备份文件**: 所有脚本都会自动创建备份文件
3. **预览模式**: 使用 `--dry-run` 参数可以预览将要更新的内容，不会实际修改文件
4. **API调用频率**: 脚本会在每次搜索后等待0.3秒，避免请求过快
5. **数据一致性**: `update_mall_coordinates.py` 会自动同步更新记忆文件，通常不需要单独运行 `update_memory_mall_coordinates.py`

---

## 📝 所有脚本文件列表

1. ✅ `update_precise_coordinates.py` - 更新门店精准经纬度
2. ✅ `match_insta360_malls.py` - 匹配Insta360门店商场
3. ✅ `unify_mall_names.py` - 统一商场名称
4. ✅ `update_mall_coordinates.py` - 根据匹配方式更新商场名称和经纬度
5. ✅ `update_memory_mall_coordinates.py` - 更新记忆文件中的商场经纬度
6. ✅ `csv_to_json.py` - 转换为前端JSON格式
7. ✅ `interactive_mall_matcher.py` - 已更新MEMORY_COLUMNS，支持商场经纬度字段

---

## ✅ 验证清单

- [x] 所有脚本文件已创建
- [x] 所有功能已实现
- [x] 记忆文件结构已更新（MEMORY_COLUMNS包含mall_lat和mall_lng）
- [x] 自动同步更新记忆文件功能已实现
- [x] 根据匹配方式设置商场名称和经纬度的逻辑已实现
- [x] 文档已更新

**所有需求已完成！** 🎉

