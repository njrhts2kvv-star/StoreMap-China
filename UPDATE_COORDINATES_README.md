# 门店坐标和商场匹配使用说明

## 功能说明

本工具集包含三个主要功能：

1. **更新精准经纬度坐标** - 通过门店名称搜索高德地图POI，获取精准的经纬度坐标
2. **匹配Insta360门店商场** - 优先匹配DJI门店的商场名称，确保同一商场的门店使用相同商场名
3. **统一商场名称** - 确保同一商场的所有门店（包括DJI和Insta360）使用完全相同的商场名称

## 前置要求

1. **Python环境**: 需要Python 3.7+
2. **依赖包**: 安装所需依赖
   ```bash
   pip install -r requirements.txt
   ```
3. **高德地图API Key**: 
   - 设置环境变量 `AMAP_WEB_KEY`，或
   - 在项目根目录创建 `.env.local` 文件，添加：
     ```
     AMAP_WEB_KEY=your_amap_api_key
     ```

## 使用步骤

### 1. 更新CSV中的经纬度坐标（可选）

如果需要更新所有门店的精准坐标，可以运行此脚本：

运行脚本搜索并更新精准坐标：

```bash
# 预览模式（不会修改文件，只显示将要更新的内容）
python update_precise_coordinates.py --dry-run

# 实际更新模式（会修改CSV文件）
python update_precise_coordinates.py
```

**说明**:
- `--dry-run` 或 `-n`: 预览模式，只显示将要更新的内容，不会实际修改文件
- 不加参数: 实际更新模式，会修改 `all_stores_final.csv` 文件
- 脚本会自动创建备份文件 `all_stores_final.csv.backup`

**搜索策略**:
- 优先使用 "品牌 + 城市 + 门店名" 搜索
- 如果未找到，尝试 "城市 + 门店名"
- 最后尝试仅使用 "门店名"
- 通过匹配分数筛选最精准的结果

### 2. 匹配Insta360门店的商场名称（重要）

**这是核心功能**：为Insta360门店匹配商场名称，优先使用DJI门店的商场名称。

```bash
# 预览模式（不会修改文件，只显示将要更新的内容）
python match_insta360_malls.py --dry-run

# 实际更新模式（会修改CSV文件）
python match_insta360_malls.py
```

**功能说明**:
- 对每个Insta360门店，先通过门店名称搜索获取精准经纬度
- 然后在DJI门店中查找匹配的门店：
  - **相近经纬度**：距离 < 500米
  - **类似门店名称**：名称相似度 >= 60%
  - **类似门店地址**：地址相似度 >= 50%
- 如果找到匹配的DJI门店，使用相同的商场名称
- 同时更新Insta360门店的经纬度为精准坐标

**匹配逻辑**:
- 综合分数 = 距离分数(40%) + 名称相似度(35%) + 地址相似度(25%)
- 只有综合分数 >= 50 才会匹配
- 优先匹配同一城市的门店

### 3. 统一商场名称（重要）

确保同一商场的所有门店（包括DJI和Insta360）使用完全相同的商场名称。

```bash
# 预览模式
python unify_mall_names.py --dry-run

# 实际更新模式
python unify_mall_names.py
```

**功能说明**:
- 根据经纬度找到商场集群（距离 < 300米认为是同一商场）
- 统一每个集群的商场名称，使用最长的商场名称作为标准
- 如果商场名称相似度 >= 70%，也会合并
- 确保同一商场的所有门店使用完全相同的商场名称

### 4. 更新商场名称和经纬度（重要）

根据匹配方式更新商场名称和经纬度，并同步更新记忆文件：

```bash
# 预览模式
python update_mall_coordinates.py --dry-run

# 实际更新模式
python update_mall_coordinates.py
```

**功能说明**:
- **自动/LLM匹配的商场**：
  - 商场名称：使用高德地图的商场名称
  - 商场经纬度：使用搜索到的商场的经纬度
- **人工手动输入的商场**：
  - 商场名称：使用人工手动输入的商场名称（保持不变）
  - 商场经纬度：使用对应门店搜索出来的高德经纬度

**规则**:
- 脚本会检查 `is_manual_confirmed` 字段来判断是否为手动匹配
- 如果 `is_manual_confirmed == "True"`，使用手动匹配规则
- 否则使用自动/LLM匹配规则
- **自动同步更新记忆文件** (`poi_memory.csv`) 中的商场经纬度

### 4.5. 更新记忆文件中的商场经纬度（可选）

如果只需要更新记忆文件中的商场经纬度，可以使用：

```bash
# 预览模式
python update_memory_mall_coordinates.py --dry-run

# 实际更新模式
python update_memory_mall_coordinates.py
```

**功能说明**:
- 读取 `poi_memory.csv` 文件
- 对于有商场名称但缺少商场经纬度的记录，根据匹配方式补充商场经纬度
- 规则与 `update_mall_coordinates.py` 相同
- 如果记录已有商场经纬度，会跳过

### 5. 将CSV转换为前端JSON格式

更新CSV后，需要转换为前端使用的JSON格式：

```bash
python csv_to_json.py
```

**说明**:
- 读取 `all_stores_final.csv`
- 分别生成 `src/data/dji_stores.json` 和 `src/data/insta360_stores.json`
- 自动解析服务标签和门店类型

## 完整工作流程

```
all_stores_final.csv (原始数据)
poi_memory.csv (记忆文件)
    ↓
match_insta360_malls.py (匹配Insta360门店商场 + 更新精准坐标)
    ↓
unify_mall_names.py (统一商场名称，确保同一商场使用相同名称)
    ↓
update_mall_coordinates.py (根据匹配方式更新商场名称和经纬度 + 同步更新记忆文件)
    ↓
all_stores_final.csv (更新后的数据)
poi_memory.csv (更新后的记忆文件，包含商场经纬度)
    ↓
csv_to_json.py (转换为JSON)
    ↓
src/data/dji_stores.json
src/data/insta360_stores.json
    ↓
前端应用使用更新后的坐标和商场信息显示地图
```

**推荐执行顺序**:
1. 先运行 `match_insta360_malls.py` 匹配Insta360门店的商场
2. 再运行 `unify_mall_names.py` 统一所有商场名称
3. 运行 `update_mall_coordinates.py` 根据匹配方式更新商场名称和经纬度（会自动同步更新记忆文件）
4. （可选）运行 `update_memory_mall_coordinates.py` 单独更新记忆文件中的商场经纬度
5. 最后运行 `csv_to_json.py` 转换为前端JSON格式

**注意**: `update_mall_coordinates.py` 会自动同步更新 `poi_memory.csv` 文件中的商场经纬度，所以通常不需要单独运行 `update_memory_mall_coordinates.py`。

## 注意事项

1. **API调用频率**: 脚本会在每次搜索后等待0.3秒，避免请求过快
2. **备份文件**: 更新CSV前会自动创建备份，文件名为 `all_stores_final.csv.backup`
3. **匹配精度**: 脚本会计算匹配分数，只有分数≥10的结果才会被采用
4. **错误处理**: 如果某个门店搜索失败，会跳过并继续处理下一个

## 示例输出

### match_insta360_malls.py 示例输出

```
[信息] 读取CSV文件: all_stores_final.csv
[信息] DJI门店: 1244 条
[信息] Insta360门店: 9 条
[信息] 模式: 更新模式
--------------------------------------------------------------------------------

[1/9] Insta360 - 影石Insta360北京朝阳合生汇授权体验店 (市辖区)
  当前坐标: lat=39.900826, lng=116.492429
  当前商场: (未匹配)
  ✓ 获取精准坐标: lat=39.899565, lng=116.486372
  高德名称: 影石Insta360北京朝阳合生汇授权体验店
  高德地址: 北京市朝阳区西大望路甲22号合生汇
  ✓ 找到匹配的DJI门店!
  DJI门店: 北京合生汇授权体验店
  距离: 450m
  名称相似度: 65.2%
  地址相似度: 78.5%
  综合分数: 72.3
  匹配商场: 北京合生汇

[统计] 总计: 9 条
[统计] 更新坐标: 8 条
[统计] 匹配商场: 6 条
[统计] 跳过: 1 条
[统计] 错误: 0 条
```

### unify_mall_names.py 示例输出

```
[信息] 读取CSV文件: all_stores_final.csv
[信息] 总计门店: 1253 条
[信息] 模式: 更新模式
--------------------------------------------------------------------------------

[信息] 分析商场集群...
[信息] 找到 156 个商场集群

[集群] 北京合生汇: 2 个门店
  品牌分布: DJI(1), Insta360(1)
  [Insta360] 影石Insta360北京朝阳合生汇授权体验店
    原商场名称: 北京朝阳合生汇
    统一为: 北京合生汇

[统计] 商场集群数: 156
[统计] 更新门店数: 23 条
```

### update_mall_coordinates.py 示例输出

```
[信息] 读取CSV文件: all_stores_final.csv
[信息] 共 856 条有商场名称的记录
[信息] 模式: 更新模式
--------------------------------------------------------------------------------

[1/856] DJI - 广州索盟百脑汇照材店 (广州市)
  商场名称: 天河百脑汇
  匹配方式: 自动
  [自动/LLM匹配] 搜索商场 '天河百脑汇' 的高德经纬度...
  ✓ 找到商场坐标: lat=23.128616, lng=113.332806
  高德商场名称: 百脑汇科技大厦
  商场坐标: lat=23.128616, lng=113.332806

[2/856] Insta360 - 影石Insta360北京朝阳合生汇授权体验店 (市辖区)
  商场名称: 北京合生汇
  匹配方式: 手动
  [手动匹配] 搜索门店 '影石Insta360北京朝阳合生汇授权体验店' 的高德经纬度...
  ✓ 找到门店坐标: lat=39.899565, lng=116.486372
  商场名称: 北京合生汇 (保持手动输入)
  商场坐标: lat=39.899565, lng=116.486372 (使用门店坐标)

[统计] 总计: 856 条
[统计] 更新: 820 条
[统计] 跳过: 36 条
[统计] 错误: 0 条
```

## 故障排除

1. **API Key错误**: 确保正确设置了 `AMAP_WEB_KEY`
2. **网络错误**: 检查网络连接，脚本会自动重试
3. **CSV格式错误**: 确保CSV文件包含必需的列：`uuid`, `brand`, `name`, `lat`, `lng`, `address`, `province`, `city`
4. **权限错误**: 确保有写入CSV文件的权限

