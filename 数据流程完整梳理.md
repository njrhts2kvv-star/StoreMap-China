# 门店数据从爬取到前端呈现的完整流程

## 📋 流程概览

门店数据从爬取到前端呈现共经历 **8个主要阶段**，包含 **20+个处理步骤**：

```
爬虫 → 合并 → 标准化 → 匹配 → 统一 → 同步 → 检查 → 转换 → 前端展示
```

---

## 🔍 详细流程步骤

### 阶段1：数据爬取（Spider）

#### 1.1 DJI门店爬取 (`spiders/dji_offline_store_spider.py`)
**输入**: DJI官方API  
**输出**: `dji_offline_stores.csv`

**处理细节**:
- ✅ 调用API: `https://www-api.dji.com/api/where-to-buy/partners`
- ✅ 分页获取所有门店（每页20条）
- ✅ **坐标转换**: 
  - 优先使用 `google_lat/google_lon` (WGS84) → 转换为 GCJ02
  - 备选使用 `baidu_lat/baidu_lon` (BD09) → 转换为 GCJ02
- ✅ 提取字段：`name`, `address`, `province`, `city`, `phone`, `business_hour`
- ✅ 生成UUID作为唯一标识
- ✅ 保存原始数据到 `raw_source` 字段（JSON格式）

#### 1.2 Insta360门店爬取 (`spiders/insta360_offline_store_spider.py`)
**输入**: Insta360官方API  
**输出**: `insta360_offline_stores.csv`

**处理细节**:
- ✅ 先获取所有城市代码列表
- ✅ 按城市逐个获取门店列表
- ✅ **坐标转换**: 
  - 使用 `gps` 字段（格式：`lng,lat`，WGS84）→ 转换为 GCJ02
- ✅ 去重处理（基于store ID）
- ✅ 请求间隔0.2秒，避免频率限制
- ✅ 提取字段：`storeName`, `address`, `provinceName`, `cityName`, `contactWay`, `businessHours`
- ✅ 生成UUID作为唯一标识
- ✅ 保存原始数据到 `raw_source` 字段（JSON格式）

**坐标转换说明**:
- 所有坐标统一转换为 **GCJ02**（高德地图坐标系）
- 转换函数位于 `spiders/store_schema.py`:
  - `convert_wgs84_to_gcj02()` - WGS84转GCJ02
  - `convert_bd09_to_gcj02()` - BD09转GCJ02

---

### 阶段2：数据合并（Merge）

#### 2.1 合并爬虫数据 (`merge_spider_data.py`)
**输入**: `dji_offline_stores.csv`, `insta360_offline_stores.csv`  
**输出**: `all_stores_final.csv`, `Store_Master_Cleaned.csv`

**处理细节**:
- ✅ **去重逻辑**: 基于 `(brand, name, address)` 三元组判断是否已存在
- ✅ **门店类型提取**:
  - DJI: 从 `raw_source` 解析 `channel_type` 和 `store_type`
    - `channel_type` 包含 "new" → "新型照材"
    - `channel_type` 包含 "ars" → "授权体验店"
    - `store_type == "7"` → "新型照材"
    - `store_type == "6"` → "授权体验店"
  - Insta360: 从 `raw_source` 解析 `chainStore`
    - "直营店" → "直营店"
    - "授权体验店"/"授权专卖店" → "授权专卖店"
    - "合作体验点" → "合作体验点"
    - 其他 → "合作体验点"
- ✅ **时间字段处理**:
  - `opened_at`: 如果为空，默认使用当前日期
  - `status`: 默认 "营业中"
- ✅ **闭店标记**:
  - 如果门店在爬虫数据中不存在，但存在于历史数据中，标记为 "已闭店"
- ✅ **UUID生成**: 
  - 如果爬虫数据没有UUID，使用 `(brand, name, address)` 的哈希值生成
- ✅ **字段映射**:
  - `all_stores_final.csv`: 包含 `uuid`, `brand`, `name`, `lat`, `lng`, `address`, `province`, `city`, `phone`, `business_hours`, `raw_source`, `mall_name`, `opened_at`, `status`, `store_type`
  - `Store_Master_Cleaned.csv`: 包含 `store_id`, `brand`, `name`, `address`, `city`, `province`, `corrected_lat`, `corrected_lng`, `mall_name`, `mall_id`, `phone`, `business_hours`, `wechat_qr_code`, `store_type`, `opened_at`, `status`
- ✅ **自动备份**: 合并前自动备份原文件（`.backup_spider` 后缀）

---

### 阶段3：数据标准化（Normalize）

#### 3.1 门店和商场数据标准化 (`normalize_store_mall_data.py`)
**输入**: `all_stores_final.csv`, `poi_memory.csv`（可选）  
**输出**: `Store_Master_Cleaned.csv`, `Mall_Master_Cleaned.csv`, `Mall_Unmatched_Log.csv`

**处理细节**:

**Step 1: 门店数据初始化**
- ✅ 从 `all_stores_final.csv` 读取门店数据
- ✅ 提取 `raw_source` 中的额外信息：
  - `wechat_qr_code`（仅DJI有）
  - `store_type`（门店类型）
- ✅ 初始化 `Store_Master` DataFrame
- ✅ **继承关联关系**: 直接保留原表中的 `mall_name` 字段（不新增匹配）

**Step 2: 商场白名单提取**
- ✅ 从门店数据中提取所有**非空**的 `mall_name`
- ✅ 去重，生成待清洗商场清单
- ✅ 为每个商场收集关联门店的坐标信息（用于后续API搜索）

**Step 3: 商场POI标准化**
- ✅ **Priority A: 查阅记忆库** (`poi_memory.csv`)
  - 如果商场名称在记忆库中存在且已确认
  - 优先使用手动确认的记录（`is_manual_confirmed=True`）
  - 直接复用其 `mall_lat`, `mall_lng`, `confirmed_mall_name`
- ✅ **Priority B: API定向验证**
  - 调用高德地图 Text Search API
  - 搜索关键词：商场名称 + 城市
  - 筛选条件：
    - 类型限制：商场类型码 `060100|060101|060102|060200|060400|060500`
    - 名称相似度 >= 50%
    - 距离门店坐标 < 500米
  - 综合评分：相似度70% + 距离30%
  - 获取最佳匹配的POI信息：`amap_name`, `amap_address`, `amap_poi_id`, `mall_lat`, `mall_lng`
- ✅ **生成商场ID**: `MALL_00001`, `MALL_00002`, ...
- ✅ **记录未匹配**: 如果API搜索失败，记录到 `Mall_Unmatched_Log.csv`

**Step 4: 数据回填与输出**
- ✅ 创建商场名称到 `mall_id` 的映射
- ✅ 回填 `mall_id` 到 `Store_Master`
- ✅ 生成三个输出文件：
  - `Store_Master_Cleaned.csv`: 门店主表（含 `mall_id`）
  - `Mall_Master_Cleaned.csv`: 商场主表（含标准化名称和坐标）
  - `Mall_Unmatched_Log.csv`: 未匹配商场日志（供人工处理）

**关键限制**:
- ❌ **禁止新增匹配**: 不会为没有关联商场的门店（如街边店）新增匹配
- ✅ **仅验证现有**: API仅用于验证和修正现有商场的元数据（名称/坐标）

---

### 阶段4：商场匹配（Match）

#### 4.1 Insta360门店商场匹配 (`match_insta360_malls.py`)
**输入**: `all_stores_final.csv`  
**输出**: `all_stores_final.csv`（更新）

**处理细节**:
- ✅ **目标**: 为Insta360门店匹配商场（优先匹配DJI门店的商场）
- ✅ **匹配策略**:
  1. **优先匹配DJI门店**:
     - 查找距离 < 500米 的DJI门店
     - 计算综合评分：
       - 距离相似度（40%）：距离越近分数越高
       - 名称相似度（35%）：使用 `rapidfuzz` 计算
       - 地址相似度（25%）：使用 `rapidfuzz` 计算
     - 综合分数 >= 50 才匹配
  2. **高德地图搜索**:
     - 如果无法匹配DJI门店，调用高德API搜索商场
     - 使用门店名称 + 地址 + 城市作为关键词
     - 搜索周边500米内的商场POI
     - 选择最佳匹配
- ✅ **更新字段**:
  - `mall_name`: 匹配到的商场名称
  - `mall_lat`, `mall_lng`: 商场坐标（如果匹配到）
  - `match_method`: "auto"（自动匹配）/ "llm"（LLM匹配）/ "manual"（手动匹配）
  - `is_manual_confirmed`: True/False
- ✅ **坐标更新**: 
  - 如果门店坐标缺失或不准确，通过门店名称搜索高德POI更新
- ✅ **API限流**: 每次请求后等待0.3秒

---

### 阶段5：商场名称统一（Unify）

#### 5.1 统一商场名称 (`unify_mall_names.py`)
**输入**: `all_stores_final.csv`  
**输出**: `all_stores_final.csv`（更新）

**处理细节**:
- ✅ **目标**: 确保同一商场的所有门店使用完全相同的商场名称
- ✅ **聚类算法**:
  1. 首先按已有 `mall_name` 分组
  2. 根据经纬度合并相近门店（距离 < 300米）
  3. 计算名称相似度（>= 70%认为相同）
- ✅ **统一规则**:
  - 对于每个商场集群，使用**最长的商场名称**作为标准名称
  - 统一所有门店的 `mall_name` 字段
- ✅ **处理范围**: 
  - 支持增量更新（`target_ids` 参数）
  - 如果未指定，则处理所有门店

---

### 阶段6：坐标同步（Sync）

#### 6.1 更新门店精准坐标（可选）(`update_precise_coordinates.py`)
**输入**: `all_stores_final.csv`  
**输出**: `all_stores_final.csv`（更新）

**处理细节**:
- ✅ **用途**: 当门店坐标缺失或不准确时，通过门店名称搜索高德POI更新坐标
- ✅ **搜索策略**:
  - 使用门店名称 + 城市作为关键词
  - 调用高德 Text Search API
  - 计算匹配分数（名称相似度 + 地址相似度）
  - 选择最佳匹配的POI坐标
- ✅ **更新条件**: 
  - 仅更新坐标缺失或明显错误的门店
  - 支持 `--dry-run` 预览模式
- ✅ **API限流**: 每次请求后等待0.3秒

#### 6.2 同步商场坐标到主表 (`update_mall_coordinates.py`)
**输入**: `all_stores_final.csv`  
**输出**: `Store_Master_Cleaned.csv`, `Mall_Master_Cleaned.csv`

**处理细节**:
- ✅ **目标**: 从 `all_stores_final.csv` 同步商场名称和坐标到主表
- ✅ **同步逻辑**:
  - **自动/LLM匹配的商场**:
    - `mall_name`: 使用高德地图的标准名称
    - `mall_lat`, `mall_lng`: 使用搜索到的商场坐标
  - **手动匹配的商场**:
    - `mall_name`: 保持手动输入的商场名称
    - `mall_lat`, `mall_lng`: 使用对应门店的高德经纬度
- ✅ **商场表更新**:
  - 更新 `Mall_Master_Cleaned.csv` 中的 `mall_name`, `mall_lat`, `mall_lng`
  - 重新计算 `store_count`（每个商场的门店数量）
- ✅ **门店表更新**:
  - 更新 `Store_Master_Cleaned.csv` 中的 `mall_name`, `mall_id`
- ✅ **增量模式**: 
  - 支持 `target_ids` 参数，只同步指定门店
  - 如果不指定，则全量同步
- ✅ **自动备份**: 同步前备份原文件（`.backup_coords` 后缀）

---

### 阶段7：数据检查（Check）

#### 7.1 全面数据检查 (`comprehensive_data_check.py`)
**输入**: `Store_Master_Cleaned.csv`, `Mall_Master_Cleaned.csv`, JSON文件  
**输出**: 检查报告

**检查项目**（共7项）:

1. **mall_id 唯一性检查**
   - ✅ 检查 `Mall_Master_Cleaned.csv` 中是否有重复的 `mall_id`
   - ✅ 如果有重复，列出所有重复项

2. **门店商场关联一致性检查**
   - ✅ 检查门店的 `mall_id` 是否都在商场表中存在
   - ✅ 检查门店的 `mall_name` 是否与商场表的 `mall_name` 一致
   - ✅ 检查商场是否有对应的门店

3. **store_count 准确性检查**
   - ✅ 检查 `Mall_Master_Cleaned.csv` 中的 `store_count` 是否与实际门店数量一致

4. **坐标合理性检查**
   - ✅ 检查坐标是否在中国境内（纬度 18-54，经度 73-135）
   - ✅ 检查门店坐标与商场坐标的距离是否合理（< 1000米）
   - ✅ 检查是否有坐标缺失

5. **城市一致性检查**
   - ✅ 检查同一商场下的门店是否在同一城市
   - ✅ 检查商场的 `city` 是否与门店的 `city` 一致

6. **JSON-CSV 一致性检查**
   - ✅ 检查前端JSON文件与CSV文件的数据是否一致
   - ✅ 检查门店数量、商场数量是否匹配
   - ✅ 检查关键字段是否一致

7. **商场名称异常检查**
   - ✅ 检查商场名称与原始名称的差异是否过大
   - ✅ 检查是否有异常字符或格式问题
   - ✅ 检查商场名称是否包含店铺特征（如"屈臣氏"、"美宜佳"等）

**检查报告**:
- ✅ 生成详细的检查报告（`DATA_CHECK_REPORT.md`）
- ✅ 记录修复历史
- ✅ 统计通过率

**检查失败处理**:
- ❌ 如果任何检查失败，`build_data.py` 会中断执行
- ✅ 需要修复数据后重新运行

---

### 阶段8：数据转换（Convert）

#### 8.1 CSV转JSON (`csv_to_json.py`)
**输入**: `Store_Master_Cleaned.csv`, `Mall_Master_Cleaned.csv`, `all_stores_final.csv`  
**输出**: `src/data/dji_stores.json`, `src/data/insta360_stores.json`, `src/data/malls.json`, `src/data/stats.json`

**处理细节**:

**门店JSON生成**:
- ✅ 读取 `Store_Master_Cleaned.csv`
- ✅ 从 `all_stores_final.csv` 读取 `raw_source` 提取服务标签：
  - `has_test_flight` → "可试飞"
  - `has_trade_in` → "支持以旧换新"
  - `has_repair` → "现场维修"
- ✅ **字段映射**:
  - `store_id` → `id`
  - `name` → `storeName`
  - `corrected_lat` → `latitude`
  - `corrected_lng` → `longitude`
  - `business_hours` → `openingHours`
  - `mall_id` → `mallId`
  - `mall_name` → `mallName`
- ✅ 按品牌分类：`dji_stores.json`, `insta360_stores.json`

**商场JSON生成**:
- ✅ 读取 `Mall_Master_Cleaned.csv`
- ✅ 统计每个商场的品牌进驻情况：
  - `hasDJI`: 是否有DJI门店
  - `hasInsta360`: 是否有Insta360门店
- ✅ 包含字段：`mallId`, `mallName`, `city`, `latitude`, `longitude`, `hasDJI`, `hasInsta360`

**统计数据生成**:
- ✅ **topCities**: 门店数量最多的前10个城市
- ✅ **provinceRanking**: 各省份的门店数量排名（分品牌统计）
- ✅ **totalStores**: 门店总数
- ✅ **updatedAt**: 更新时间（UTC时间）

**城市归一化**:
- ✅ 如果 `city == "市辖区"`，使用 `province` 作为城市名
- ✅ 如果城市为空，使用 "未知"

---

### 阶段9：前端展示（Frontend）

#### 9.1 数据加载 (`src/hooks/useStores.ts`)
**输入**: JSON文件  
**输出**: 前端可用的门店数据

**处理细节**:
- ✅ 导入JSON文件：
  - `dji_stores.json`
  - `insta360_stores.json`
  - `malls.json`
  - `stats.json`
- ✅ 合并所有门店数据
- ✅ 计算距离（如果用户位置可用）
- ✅ 应用筛选条件：
  - 关键词搜索（门店名称、地址）
  - 省份/城市筛选
  - 品牌筛选
  - 门店类型筛选
  - 服务标签筛选
  - 收藏筛选
  - 竞争门店筛选（同一商场有多个品牌）
  - 新店筛选（本月新开）
- ✅ 排序：默认排序或按距离排序

#### 9.2 地图展示 (`src/components/AmapStoreMap.tsx`)
**处理细节**:
- ✅ 使用高德地图API显示门店位置
- ✅ 不同品牌使用不同图标
- ✅ 显示商场聚合（如果多个门店在同一商场）
- ✅ 点击门店显示详情弹窗
- ✅ 支持收藏功能
- ✅ 支持定位用户位置

#### 9.3 列表展示 (`src/components/StoreList.tsx`)
**处理细节**:
- ✅ 使用虚拟滚动（`react-virtuoso`）优化性能
- ✅ 显示门店基本信息：名称、地址、距离、服务标签
- ✅ 显示商场信息（如果有）
- ✅ 收藏按钮
- ✅ 导航链接（Google Maps）
- ✅ 电话链接（如果有）

---

## 🔄 完整工作流程（推荐执行顺序）

### 自动化流程 (`build_data.py`)

```bash
python build_data.py
```

**执行顺序**:
1. ✅ **抓取最新门店**（可选）
   - 运行 `dji_offline_store_spider.py`
   - 运行 `insta360_offline_store_spider.py`
   - 运行 `merge_spider_data.py`

2. ✅ **增量更新检测**
   - 检测 `opened_at` 晚于上次处理日期的新增门店
   - 如果无新增，仅同步全量数据并导出JSON

3. ✅ **匹配 Insta360 商场**
   - 运行 `match_insta360_malls.py`（仅处理新增门店）

4. ✅ **统一商场名称**
   - 运行 `unify_mall_names.py`（仅处理新增门店）

5. ✅ **同步商场/坐标到主表**
   - 运行 `update_mall_coordinates.py`（仅处理新增门店）

6. ✅ **全面数据检查**
   - 运行 `comprehensive_data_check.py`
   - 如果检查失败，中断执行

7. ✅ **导出 JSON 及统计数据**
   - 运行 `csv_to_json.py`

8. ✅ **保存状态**
   - 记录最后处理的 `opened_at` 日期

### 手动流程（首次或全量更新）

```bash
# 1. 爬取数据（如果需要）
python spiders/dji_offline_store_spider.py
python spiders/insta360_offline_store_spider.py
python merge_spider_data.py

# 2. 标准化数据
python normalize_store_mall_data.py

# 3. 匹配Insta360门店的商场
python match_insta360_malls.py

# 4. 统一商场名称
python unify_mall_names.py

# 5. 同步商场坐标
python update_mall_coordinates.py

# 6. 数据检查
python comprehensive_data_check.py

# 7. 转换为JSON
python csv_to_json.py
```

---

## 📊 数据文件说明

### 核心CSV文件

1. **`all_stores_final.csv`** - 主数据表
   - 包含所有门店的完整信息
   - 包含商场匹配结果
   - 包含原始数据（`raw_source`）

2. **`Store_Master_Cleaned.csv`** - 门店主表
   - 前端数据源
   - 包含清洗后的坐标和商场关联

3. **`Mall_Master_Cleaned.csv`** - 商场主表
   - 包含所有商场的标准化信息
   - 包含商场坐标和门店数量

4. **`poi_memory.csv`** - 记忆库（可选）
   - 存储历史确认过的商场POI信息
   - 用于加速后续处理

### 前端JSON文件

1. **`src/data/dji_stores.json`** - DJI门店数据
2. **`src/data/insta360_stores.json`** - Insta360门店数据
3. **`src/data/malls.json`** - 商场数据
4. **`src/data/stats.json`** - 统计数据

---

## ⚠️ 关键注意事项

### 1. 坐标系统
- ✅ 所有坐标统一使用 **GCJ02**（高德地图坐标系）
- ✅ 爬虫阶段完成坐标转换
- ✅ 后续处理不再转换坐标

### 2. 数据一致性
- ✅ `all_stores_final.csv` 是数据源头
- ✅ `Store_Master_Cleaned.csv` 和 `Mall_Master_Cleaned.csv` 从源头同步
- ✅ JSON文件从主表生成，确保一致性

### 3. 增量更新
- ✅ `build_data.py` 支持增量更新
- ✅ 基于 `opened_at` 字段检测新增门店
- ✅ 只处理新增门店，提高效率

### 4. API限流
- ✅ 所有API调用都有延迟（0.2-0.3秒）
- ✅ 避免触发API频率限制

### 5. 备份机制
- ✅ 所有关键操作前自动备份
- ✅ 备份文件后缀：`.backup_spider`, `.backup_coords` 等

### 6. 错误处理
- ✅ 数据检查失败会中断流程
- ✅ 需要修复数据后重新运行

---

## 🔍 可能遗漏的细节

### 已覆盖的细节 ✅
- ✅ 坐标系统转换（WGS84/BD09 → GCJ02）
- ✅ 门店类型提取和映射
- ✅ 服务标签提取（可试飞、以旧换新、现场维修）
- ✅ 闭店标记逻辑
- ✅ 去重逻辑（基于品牌+名称+地址）
- ✅ UUID生成和一致性
- ✅ 商场名称统一和聚类
- ✅ 距离计算和匹配算法
- ✅ 数据备份机制
- ✅ 增量更新机制
- ✅ 数据一致性检查
- ✅ 城市归一化处理
- ✅ 记忆库复用机制

---

## 🏙️ 商圈维度（Business Area）

在现有“行政区（Region）+ 商场（Mall）+ 门店（Store）”基础上，引入“商圈（Business Area）”作为独立维度，用于承载高德逆地理编码返回的商圈信息，并与门店/商场做关联。

### 维度模型

- 后端模型：`backend/app/models/business_area.py`
  - 表名：`business_area`
  - 字段：
    - `id`：`business_area_id` 主键
    - `name`：商圈名称（如“中关村”“望京”）
    - `amap_id`：高德商圈ID（如返回）
    - `adcode`：行政区划代码
    - `city_code` / `district_code`：城市/区县编码（可与 `dim_region` 对应）
    - `center_lat` / `center_lng`：商圈中心点坐标
    - `region_id`：关联 `dim_region.id`（可选）
  - 关系：
    - `Region.business_areas` ←→ `BusinessArea.region`
    - `Store.business_area` ←→ `BusinessArea.stores`
    - `Mall.business_area` ←→ `BusinessArea.malls`

- 门店/商场模型扩展：
  - `Store`：
    - 新增列：`business_area_id`（可为空）
    - 索引：`idx_store_business_area`
  - `Mall`：
    - 新增列：`business_area_id`（可为空）
    - 索引：`idx_mall_business_area`

> 说明：在数据库层面，商圈是一个独立的维度表，通过 `business_area_id` 与门店/商场关联；多个门店、多个商场可以落在同一个商圈。

### 商圈数据生成流程

新增脚本：`build_business_areas.py`，基于门店/商场主表的坐标，通过高德逆地理编码推导商圈，并生成商圈维度表和映射表。

**输入：**
- `Store_Master_Cleaned.csv`
- `Mall_Master_Cleaned.csv`

**输出：**
- `BusinessArea_Master.csv` ：商圈维度表
  - `business_area_id`, `name`, `amap_id`, `adcode`, `city`, `district`, `center_lat`, `center_lng`
- `Store_With_BusinessArea.csv` ：门店 + 商圈映射
  - 在 `Store_Master_Cleaned` 基础上新增列 `business_area_id`
- `Mall_With_BusinessArea.csv` ：商场 + 商圈映射
  - 在 `Mall_Master_Cleaned` 基础上新增列 `business_area_id`

**核心逻辑：**
- 对每个门店/商场的有效坐标调用高德逆地理编码 API：
  - 接口：`/v3/geocode/regeo`
  - 参数：`location=lng,lat`, `extensions=all`, `radius=50`
- 从返回值中解析：
  - `regeocode.addressComponent.businessAreas[0]` 作为“主商圈”
  - 若提供 `id/location` 则记为 `amap_id` 和中心点坐标
  - 同时读取 `adcode`、`city`、`district` 作为行政区信息
- 商圈维度去重规则：
  - 维度主键优先使用 `amap_id`
  - 否则使用 `name + adcode` 组合
  - 即“同城市内同名商圈”视为同一个商圈
- 多个门店/商场共享同一商圈维度记录：
  - 先构建商圈维度字典 `ba_map`
  - 再为每个 `store_id` / `mall_id` 关联其对应的 `business_area_id`

**使用方式：**

```bash
export AMAP_WEB_KEY=你的高德Web服务key  # 或在 .env.local 中配置
python build_business_areas.py
```

执行后即可得到：
- 一份相对完整的“本业务覆盖范围内的商圈库”（`BusinessArea_Master.csv`）
- 门店/商场与商圈的一对多关联关系（多个门店/商场 → 一个商圈）

**后续集成建议：**
- 若使用 PostgreSQL + SQLAlchemy：
  - 按 `business_area` 模型建表（或迁移）
  - 用 `BusinessArea_Master.csv` 初始化维度表
  - 根据 `Store_With_BusinessArea.csv` / `Mall_With_BusinessArea.csv` 回填 `business_area_id`
- 前端可选：
  - 在门店/商场详情中展示所属商圈名称
  - 在地图上按商圈聚合（如“某商圈共有 N 家门店 / M 个商场”）

### 数据修复脚本（历史问题修复）🔧

项目中还包含多个修复脚本，用于修复历史数据问题：

1. **`fix_all_data_issues.py`** - 综合数据修复
2. **`fix_duplicate_mall_ids.py`** - 修复重复的商场ID
3. **`fix_wrong_mall_associations.py`** - 修复错误的商场关联
4. **`fix_out_of_bounds_coords.py`** - 修复超出边界的坐标
5. **`fix_new_store_types.py`** - 修复门店类型
6. **`fix_mall_names_with_llm.py`** - 使用LLM修复商场名称
7. **`fix_multi_store_malls_with_llm.py`** - 使用LLM修复多门店商场
8. **`sync_mall_names.py`** - 同步商场名称

这些脚本通常用于一次性修复历史数据问题，不在常规流程中执行。

### 交互式工具 🛠️

1. **`interactive_mall_matcher.py`** - 交互式商场匹配工具
   - 用于手动匹配和确认商场关联
   - 支持记忆库保存

2. **`interactive_merge_malls.py`** - 交互式商场合并工具
   - 用于手动合并重复的商场

### 需要确认的细节 ❓
- ❓ 是否有数据验证规则（如地址格式、电话格式）
- ❓ 是否有数据质量监控（如坐标漂移检测）
- ❓ 是否有异常数据告警机制
- ❓ 是否有数据版本管理
- ❓ 是否有回滚机制（如果数据出错）
- ❓ 是否有数据变更日志记录

---

## 📝 总结

门店数据从爬取到前端呈现共经历 **9个主要阶段**，包含 **20+个处理步骤**：

1. **爬虫阶段**: 2个爬虫脚本，处理坐标转换
2. **合并阶段**: 1个合并脚本，处理去重和类型提取
3. **标准化阶段**: 1个标准化脚本，处理商场POI匹配
4. **匹配阶段**: 1个匹配脚本，处理Insta360商场匹配
5. **统一阶段**: 1个统一脚本，处理商场名称统一
6. **同步阶段**: 1个同步脚本，处理坐标同步
7. **检查阶段**: 1个检查脚本，处理数据一致性验证
8. **转换阶段**: 1个转换脚本，处理CSV到JSON转换
9. **前端阶段**: 多个组件，处理数据展示和交互

整个流程设计合理，覆盖了数据处理的各个环节，确保了数据的准确性和一致性。

---

## ✅ 快速检查清单

### 数据爬取阶段
- [x] DJI门店爬取（坐标转换：WGS84/BD09 → GCJ02）
- [x] Insta360门店爬取（坐标转换：WGS84 → GCJ02）
- [x] UUID生成和唯一性保证
- [x] 原始数据保存（raw_source字段）

### 数据合并阶段
- [x] 去重逻辑（基于品牌+名称+地址）
- [x] 门店类型提取和映射
- [x] 时间字段处理（opened_at, status）
- [x] 闭店标记逻辑
- [x] 自动备份机制

### 数据标准化阶段
- [x] 门店数据初始化
- [x] 商场白名单提取
- [x] 记忆库查询（优先）
- [x] API POI匹配（备选）
- [x] 商场ID生成
- [x] 未匹配记录日志

### 商场匹配阶段
- [x] Insta360门店优先匹配DJI门店
- [x] 综合评分算法（距离+名称+地址）
- [x] 高德API搜索备选
- [x] 坐标更新（如果缺失）
- [x] 匹配方式标记（auto/llm/manual）

### 商场名称统一阶段
- [x] 经纬度聚类（300米阈值）
- [x] 名称相似度计算
- [x] 统一使用最长名称
- [x] 增量更新支持

### 坐标同步阶段
- [x] 门店精准坐标更新（可选）
- [x] 商场坐标同步到主表
- [x] 匹配方式区分处理
- [x] 自动备份机制
- [x] 增量更新支持

### 数据检查阶段
- [x] mall_id唯一性检查
- [x] 门店商场关联一致性检查
- [x] store_count准确性检查
- [x] 坐标合理性检查（边界、距离）
- [x] 城市一致性检查
- [x] JSON-CSV一致性检查
- [x] 商场名称异常检查
- [x] 检查报告生成

### 数据转换阶段
- [x] 服务标签提取（可试飞、以旧换新、现场维修）
- [x] 门店类型映射
- [x] 字段名称转换
- [x] 城市归一化处理
- [x] 统计数据预计算
- [x] 品牌进驻情况统计

### 前端展示阶段
- [x] JSON数据加载
- [x] 筛选功能（关键词、地区、品牌、类型、标签）
- [x] 排序功能（默认、距离）
- [x] 地图展示（高德地图）
- [x] 列表展示（虚拟滚动）
- [x] 收藏功能
- [x] 距离计算

### 其他功能
- [x] 增量更新机制（基于opened_at）
- [x] 自动化流程（build_data.py）
- [x] 数据修复脚本（历史问题）
- [x] 交互式工具（手动匹配、合并）
- [x] API限流处理
- [x] 错误处理和日志记录

---

## 📊 数据统计

根据 `DATA_CHECK_REPORT.md`，当前数据规模：
- **商场总数**: 581 条
- **门店总数**: 1229 条
  - DJI: 788 条
  - Insta360: 441 条
- **数据检查通过率**: 100% (7/7)

---

## 🎯 总结

门店数据从爬取到前端呈现共经历 **9个主要阶段**，包含 **30+个处理步骤**，涵盖了：

✅ **数据获取**: 2个爬虫脚本  
✅ **数据处理**: 6个核心处理脚本  
✅ **数据检查**: 1个全面检查脚本  
✅ **数据转换**: 1个转换脚本  
✅ **前端展示**: 多个React组件  
✅ **辅助工具**: 多个修复和交互式工具  

整个流程设计完善，确保了数据的**准确性**、**一致性**和**可维护性**。
